{% extends "base.html" %}

{% block content %}
<div class="container mt-3 mb-4">
  <a href="{{ url_for('home') }}" class="btn btn-link">&larr; Back to Home</a>
</div>
<div class="container mt-4 mb-5">
    <div class="text-center">
        <h2 class="display-6 mb-4">üì¶ Outdated Albums in Library</h2>
    </div>
    <p class="text-center text-muted mb-4">
      These albums are stored in your library, but Spotify now recommends a different version of the same album.
      This can happen if Spotify reissues, republishes, or updates album metadata.<br>
      <strong>To fix:</strong> Click the album link below to visit it on Spotify. Remove it from your library, and add the version Spotify now recommends. Then re-run your sync to update.
    </p>

    {% if outdated_albums %}
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm sortable">
            <thead class="thead-dark">
                <tr>
                    <th class="text-nowrap" onclick="sortTable(this.cellIndex)">saved_album_id</th>
                    <th onclick="sortTable(this.cellIndex)">album_name</th>
                    <th onclick="sortTable(this.cellIndex)">artist_name</th>
                    <th onclick="sortTable(this.cellIndex)">Saved Album Link</th>
                    <th class="text-nowrap" onclick="sortTable(this.cellIndex)">newer_album_id</th>
                    <th onclick="sortTable(this.cellIndex)">Newer Album Link</th>
                    <th onclick="sortTable(this.cellIndex)">first_detected_at</th>
                </tr>
            </thead>
            <tbody>
                {% for row in outdated_albums %}
                <tr>
                    <td class="text-nowrap small text-monospace">{{ row[3] }}</td>
                    <td>{{ row[2] }}</td>
                    <td>{{ row[1] }}</td>
                    <td><a href="https://open.spotify.com/album/{{ row[3] }}" target="_blank">View</a></td>
                    <td class="text-nowrap small text-monospace">{{ row[4] }}</td>
                    <td><a href="https://open.spotify.com/album/{{ row[4] }}" target="_blank">View</a></td>
                    <td>{{ row[5] }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-success text-center" role="alert">
        ‚úÖ No outdated albums found in your library!
    </div>
    {% endif %}
</div>
<hr class="my-5">
<div class="container mt-4 mb-5">
    <div class="text-center">
        <h2 class="display-6 mb-4">üö® Duplicate Album Tracks Detected</h2>
    </div>
    <p class="text-center text-muted mb-4">
      This table highlights albums in your library where the number of expected tracks doesn't match what's stored, possibly due to duplicate or partial entries.<br>
      <strong>To fix:</strong> Visit the linked album in Spotify, remove all versions from your library, and re-add the correct one. Then re-run your sync to update.
    </p>

    {% if duplicates %}
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-sm">
                <thead class="thead-dark">
                    <tr>
                        <th class="text-nowrap">Album ID</th>
                        <th>Album Name</th>
                        <th class="text-end">Expected Tracks</th>
                        <th class="text-end">Actual Tracks</th>
                        <th class="text-end">Extra Tracks</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in duplicates %}
                    <tr>
                        <td class="text-nowrap"><a href="https://open.spotify.com/album/{{ row[0] }}" target="_blank"><span class="small text-monospace">{{ row[0] }}</span></a></td>
                        <td>{{ row[1] }}</td>
                        <td class="text-end">{{ row[2] }}</td>
                        <td class="text-end">{{ row[3] }}</td>
                        <td class="text-end">{{ row[4] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="alert alert-success text-center" role="alert">
            üéâ No duplicate album track issues found!
        </div>
    {% endif %}
</div>
<hr class="my-5">
<div class="container mt-5 mb-5">
    <div class="text-center">
        <h2 class="display-6 mb-4">üóëÔ∏è Playlists Flagged for Deletion</h2>
    </div>
    <p class="text-center text-muted mb-4">
        These playlists were not found during the last sync. You can choose to delete the mapping or ignore the flag and keep them.
    </p>

    {% if pending_playlists %}
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-sm">
            <thead class="thead-dark">
                <tr>
                    <th>Playlist Name</th>
                    <th class="text-nowrap">Slug</th>
                    <th class="text-end">Missing Count</th>
                    <th>Last Missing</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for pl in pending_playlists %}
                <tr>
                    <td>{{ pl.name }}</td>
                    <td class="text-nowrap small text-monospace">{{ pl.slug }}</td>
                    <td class="text-end">{{ pl.missing_count }}</td>
                    <td>{{ pl.last_missing_at }}</td>
                    <td>
                        <form method="POST" action="{{ url_for('delete_playlist_route', slug=pl.slug) }}" style="display:inline;">
                            <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                        </form>
                        <form method="POST" action="{{ url_for('ignore_playlist', slug=pl.slug) }}" style="display:inline;">
                            <button type="submit" class="btn btn-secondary btn-sm">Ignore</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="alert alert-success text-center" role="alert">
        ‚úÖ No playlists flagged for deletion!
    </div>
    {% endif %}
</div>
<hr class="my-5">
<div class="container mt-5 mb-5">
    <div class="text-center">
        <h2 class="display-6 mb-4">üîÅ Track ID Equivalents</h2>
    </div>
    <p class="text-center text-muted mb-4">
      Use this to manually declare that an <strong>alias</strong> Spotify track ID (often seen in play history) should be treated as the
      <strong>canonical</strong> track ID (the one you want to represent the track in your library/playlists).<br>
      This is useful when Spotify plays a different ID for the same track name/artist and you cannot ‚Äúfix‚Äù it by re-liking.
    </p>

    <div class="row justify-content-center">
      <div class="col-lg-10">
        <div class="card shadow-sm mb-4">
          <div class="card-body">
            <h5 class="card-title mb-3">Add / Update Mapping</h5>
            <form method="POST" action="{{ url_for('upsert_track_equivalent') }}">
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Alias Track ID (played)</label>
                  <input name="alias_track_id" class="form-control" placeholder="e.g. 56789" required>
                  <div class="form-text">This is the track ID you see coming in from plays.</div>
                </div>
                <div class="col-md-6">
                  <label class="form-label">Canonical Track ID (library)</label>
                  <input name="canonical_track_id" class="form-control" placeholder="e.g. 12345" required>
                  <div class="form-text">This is the track ID you want the system to treat as the ‚Äúreal‚Äù one.</div>
                </div>
                <div class="col-12">
                  <label class="form-label">Reason (optional)</label>
                  <input name="reason" class="form-control" placeholder="e.g. Same recording; Spotify relinked to another ID">
                </div>
              </div>
              <div class="text-center mt-3">
                <button type="submit" class="btn btn-primary">Save mapping</button>
              </div>
            </form>
          </div>
        </div>

        <div class="card shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-3">Existing Mappings</h5>

            {% if track_equivalents %}
              <div class="table-responsive">
                <table class="table table-striped table-bordered table-sm">
                  <thead class="thead-dark">
                    <tr>
                      <th>Alias Track ID</th>
                      <th>Canonical Track ID</th>
                      <th>Reason</th>
                      <th>Created By</th>
                      <th class="text-nowrap">Created At</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in track_equivalents %}
                      <tr>
                        <td class="small text-monospace text-nowrap">{{ row[0] }}</td>
                        <td class="small text-monospace text-nowrap">{{ row[1] }}</td>
                        <td>{{ row[2] or '' }}</td>
                        <td>{{ row[3] or '' }}</td>
                        <td class="text-nowrap">{{ row[4] }}</td>
                        <td>
                          <form method="POST" action="{{ url_for('delete_track_equivalent') }}" style="display:inline;">
                            <input type="hidden" name="alias_track_id" value="{{ row[0] }}">
                            <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Delete this mapping?')">Delete</button>
                          </form>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-success text-center" role="alert">
                ‚úÖ No manual track equivalences yet.
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
</div>
<hr class="my-5">
<div class="container mt-5 mb-5">
    <div class="text-center">
        <h2 class="display-6 mb-4">üïµÔ∏è Fuzzy Matched Plays</h2>
    </div>
    <p class="text-center text-muted mb-4">
      This table is showing tracks played that don't match the 
      <span data-toggle="tooltip" title="The track version stored in your personal library ‚Äî typically from a specific album you've saved.">stored album version</span> 
      in your library.<br>
      <strong>Options:</strong> Check in Spotify that you have the 
      <span data-toggle="tooltip" title="Spotify often links multiple versions of the same album ‚Äî make sure you're using the most up-to-date or canonical version.">correct (default) album version</span> 
      added and remove any incorrect or duplicate versions. Once sorted, you can mark the row as resolved.<br>
      Or, simply ignore ‚Äî the plays are tracked, but your 
      <span data-toggle="tooltip" title="Automatically generated playlists based on your library and listening activity.">smart playlists</span> 
      will only show tracks from your saved library, meaning you'll see the stored version but Spotify will likely play the newer one.
    </p>

    {% if fuzzy_matches %}
    <form method="POST" action="/resolve_fuzzy_matches">
        <div class="table-responsive">
            <table class="table table-striped table-bordered table-sm sortable">
                <thead class="thead-dark">
                    <tr>
                        <th onclick="sortTable(this.cellIndex)">Select</th>
                        <th onclick="sortTable(this.cellIndex)">Play Time</th>
                        <th class="text-nowrap" onclick="sortTable(this.cellIndex)">Original Track ID</th>
                        <th onclick="sortTable(this.cellIndex)">Original Track Name</th>
                        <th onclick="sortTable(this.cellIndex)">Original Artist</th>
                        <th class="text-nowrap" onclick="sortTable(this.cellIndex)">Matched Track ID</th>
                        <th onclick="sortTable(this.cellIndex)">Library Track Name</th>
                        <th onclick="sortTable(this.cellIndex)">Library Artist</th>
                        <th class="text-nowrap" onclick="sortTable(this.cellIndex)">Library Album ID</th>
                        <th onclick="sortTable(this.cellIndex)">Library Album Name</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in fuzzy_matches %}
                    <tr>
                        <td><input type="checkbox" name="selected_track_ids" value="{{ row[5] }}"></td>
                        <td>{{ row[4] }}</td>
                        <td class="text-nowrap small text-monospace">{{ row[1] }}</td>
                        <td>{{ row[2] }}</td>
                        <td>{{ row[3] }}</td>
                        <td class="text-nowrap small text-monospace">{{ row[5] }}</td>
                        <td>{{ row[6] }}</td>
                        <td>{{ row[7] }}</td>
                        <td class="text-nowrap small text-monospace">{{ row[8] }}</td>
                        <td>{{ row[9] }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="text-center mt-3">
            <button type="submit" class="btn btn-primary">Mark Selected as Resolved</button>
        </div>
    </form>
    {% else %}
        <div class="alert alert-success text-center" role="alert">
            ‚úÖ No fuzzy matched plays found!
        </div>
    {% endif %}
</div>
<hr class="my-5">
<div class="container mt-5 mb-5">
    <div class="text-center">
        <h2 class="display-6 mb-4">üßÆ Albums with Mismatched Track Counts</h2>
    </div>
    <p class="text-center text-muted mb-4">
      These albums report a different number of total tracks in Spotify metadata than what is currently stored in your library.<br>
      <strong>To fix:</strong> Check the album on Spotify and re-trigger sync for the album. You can also use the checkbox to flag it for re-download on next run.
    </p>

    {% if mismatches %}
        <form method="POST" action="/flag_mismatched_albums">
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-sm sortable">
                    <thead class="thead-dark">
                        <tr>
                            <th>Select</th>
                            <th class="text-nowrap">Album ID</th>
                            <th>Album Name</th>
                            <th>Artist</th>
                            <th class="text-end">Total Tracks (Expected)</th>
                            <th class="text-end">Stored Tracks</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in mismatches %}
                        <tr>
                            <td><input type="checkbox" name="selected_album_ids" value="{{ row[0] }}"></td>
                            <td class="text-nowrap"><a href="https://open.spotify.com/album/{{ row[0] }}" target="_blank"><span class="small text-monospace">{{ row[0] }}</span></a></td>
                            <td>{{ row[1] }}</td>
                            <td>{{ row[2] }}</td>
                            <td class="text-end">{{ row[3] }}</td>
                            <td class="text-end">{{ row[4] }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="text-center mt-3">
                <button type="submit" class="btn btn-warning">Mark Selected for Re-Sync</button>
            </div>
        </form>
    {% else %}
        <div class="alert alert-success text-center" role="alert">
            ‚úÖ No track count mismatches found!
        </div>
    {% endif %}
</div>
<script>
function sortTable(columnIndex) {
    var table = document.querySelector(".sortable");
    var rows = Array.from(table.rows).slice(1);
    var header = table.rows[0].cells[columnIndex];
    var ascending = header.classList.toggle("asc");

    rows.sort((a, b) => {
        let aText = a.cells[columnIndex].innerText.trim();
        let bText = b.cells[columnIndex].innerText.trim();

        return ascending
            ? aText.localeCompare(bText, undefined, {numeric: true})
            : bText.localeCompare(aText, undefined, {numeric: true});
    });

    rows.forEach(row => table.tBodies[0].appendChild(row));
}
</script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-toggle="tooltip"]'))
    tooltipTriggerList.forEach(function (tooltipTriggerEl) {
      new bootstrap.Tooltip(tooltipTriggerEl)
    })
  });
</script>
{% endblock %}